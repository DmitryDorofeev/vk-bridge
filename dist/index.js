"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var __assign=function(){return(__assign=Object.assign||function(e){for(var r,n=1,t=arguments.length;n<t;n++)for(var o in r=arguments[n])Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o]);return e}).apply(this,arguments)};function __rest(e,r){var n={};for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&r.indexOf(t)<0&&(n[t]=e[t]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var o=0,t=Object.getOwnPropertySymbols(e);o<t.length;o++)r.indexOf(t[o])<0&&Object.prototype.propertyIsEnumerable.call(e,t[o])&&(n[t[o]]=e[t[o]]);return n}function __spreadArrays(){for(var e=0,r=0,n=arguments.length;r<n;r++)e+=arguments[r].length;for(var t=Array(e),o=0,r=0;r<n;r++)for(var i=arguments[r],a=0,p=i.length;a<p;a++,o++)t[o]=i[a];return t}function createCounter(){return{current:0,next:function(){return++this.current}}}function createRequestResolver(){var t=createCounter(),o={};return{add:function(e,r){var n=null!=r?r:t.next();return o[n]=e,n},resolve:function(e,r,n){var t=o[e];t&&(n(r)?t.resolve(r):t.reject(r),o[e]=null)}}}function promisifySend(i,e){var a=createRequestResolver();return e(function(e){var r,n,t;e.detail&&e.detail.data&&"request_id"in e.detail.data&&(n=(r=e.detail.data).request_id,t=__rest(r,["request_id"]),n&&a.resolve(n,t,function(e){return!("error_type"in e)}))}),function(t,o){return void 0===o&&(o={}),new Promise(function(e,r){var n=a.add({resolve:e,reject:r},o.request_id);i(t,__assign(__assign({},o),{request_id:n}))})}}var IS_CLIENT_SIDE="undefined"!=typeof window,IS_ANDROID_WEBVIEW=Boolean(IS_CLIENT_SIDE&&window.AndroidBridge),IS_IOS_WEBVIEW=Boolean(IS_CLIENT_SIDE&&window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.VKWebAppClose),IS_WEB=IS_CLIENT_SIDE&&!IS_ANDROID_WEBVIEW&&!IS_IOS_WEBVIEW,IS_MVK=IS_WEB&&/(^\?|&)vk_platform=mobile_web(&|$)/.test(location.search),IS_DESKTOP_VK=IS_WEB&&!IS_MVK,EVENT_TYPE=IS_WEB?"message":"VKWebAppEvent",DESKTOP_METHODS=__spreadArrays(["VKWebAppInit","VKWebAppGetCommunityAuthToken","VKWebAppAddToCommunity","VKWebAppGetUserInfo","VKWebAppSetLocation","VKWebAppGetClientVersion","VKWebAppGetPhoneNumber","VKWebAppGetEmail","VKWebAppGetGeodata","VKWebAppSetTitle","VKWebAppGetAuthToken","VKWebAppCallAPIMethod","VKWebAppJoinGroup","VKWebAppLeaveGroup","VKWebAppAllowMessagesFromGroup","VKWebAppDenyNotifications","VKWebAppAllowNotifications","VKWebAppOpenPayForm","VKWebAppOpenApp","VKWebAppShare","VKWebAppShowWallPostBox","VKWebAppScroll","VKWebAppShowOrderBox","VKWebAppShowLeaderBoardBox","VKWebAppShowInviteBox","VKWebAppShowRequestBox","VKWebAppAddToFavorites","VKWebAppShowCommunityWidgetPreviewBox","VKWebAppShowStoryBox","VKWebAppStorageGet","VKWebAppStorageGetKeys","VKWebAppStorageSet"],IS_DESKTOP_VK?["VKWebAppResizeWindow","VKWebAppAddToMenu"]:[]),RNBridge=IS_CLIENT_SIDE?window.ReactNativeWebView:void 0,androidBridge=IS_CLIENT_SIDE?window.AndroidBridge:void 0,iosBridge=IS_IOS_WEBVIEW?window.webkit.messageHandlers:void 0;function createVKBridge(n){var i=void 0,a=[];function e(e){a.push(e)}"undefined"!=typeof window&&"addEventListener"in window&&window.addEventListener(EVENT_TYPE,function(r){return IS_IOS_WEBVIEW||IS_ANDROID_WEBVIEW?__spreadArrays(a).map(function(e){return e.call(null,r)}):void((IS_WEB||RNBridge)&&r&&r.data&&(e=r.data,n=e.type,t=e.data,o=e.frameId,n&&"VKWebAppSettings"===n?i=o:__spreadArrays(a).map(function(e){return e({detail:{type:n,data:t}})})));var e,n,t,o});var r=promisifySend(function(e,r){androidBridge&&androidBridge[e]?androidBridge[e](JSON.stringify(r)):iosBridge&&iosBridge[e]&&"function"==typeof iosBridge[e].postMessage?iosBridge[e].postMessage(r):RNBridge?RNBridge.postMessage(JSON.stringify({handler:e,params:r,type:"vk-connect",webFrameId:i,connectVersion:n})):IS_WEB&&parent.postMessage({handler:e,params:r,type:"vk-connect",webFrameId:i,connectVersion:n},"*")},e);return{send:r,sendPromise:r,subscribe:e,unsubscribe:function(e){var r=a.indexOf(e);-1<r&&a.splice(r,1)},supports:function(e){return IS_ANDROID_WEBVIEW?!(!androidBridge||"function"!=typeof androidBridge[e]):IS_IOS_WEBVIEW?!(!iosBridge||!iosBridge[e]||"function"!=typeof iosBridge[e].postMessage):!(!IS_WEB&&!RNBridge)&&-1<DESKTOP_METHODS.indexOf(e)},isWebView:function(){return IS_IOS_WEBVIEW||IS_ANDROID_WEBVIEW}}}function createCustomEventPolyfill(){function e(e,r){var n=r||{bubbles:!1,cancelable:!1,detail:void 0},t=document.createEvent("CustomEvent");return t.initCustomEvent(e,!!n.bubbles,!!n.cancelable,n.detail),t}return e.prototype=Event.prototype,e}var version="2.2.2";function applyMiddleware(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return t.includes(void 0)||t.includes(null)?applyMiddleware.apply(void 0,t.filter(function(e){return"function"==typeof e})):function(n){if(0===t.length)return n;var r={subscribe:n.subscribe,send:function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return n.send.apply(n,e)}},e=t.filter(function(e){return"function"==typeof e}).map(function(e){return e(r)}).reduce(function(r,n){return function(e){return r(n(e))}})(n.send);return __assign(__assign({},n),{send:e})}}"undefined"==typeof window||window.CustomEvent||(window.CustomEvent=createCustomEventPolyfill());var bridge=createVKBridge(version);exports.applyMiddleware=applyMiddleware,exports.default=bridge;
